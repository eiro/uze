# example of configuration (from .zshenv): 
# typeset -A SYMPARC
# . uze/sympa
# SYMPARC=(
#    arc_path $( sympa/rc/get arc_path /etc/sympa/wwsympa.conf ) 
#    queueoutgoing $( sympa/rc/get queueoutgoing /etc/sympa/sympa.conf ) 
#    arc_path  $( sympa/rc/get arc_path /etc/sympa/wwsympa.conf ) 
#    root      ~/expl
#    pl        /usr/lib/sympa/bin/sympa.pl
#    etc       /etc/sympa
#    bot       example.com
#    botglob   '*.(com|org|fr|net)'
# )

# get a single key stored in a single line in a sympa config file 
# example:
# sympa/rc/get queueoutgoing /etc/sympa/sympa.conf 
sympa/rc/get () {
    local key=${1:?key in the file} file=${2:?file to seek the key}
    sed -n "s/^$key\s*//;T;p;q" $file
}

# dump the SYMPARC structure a readable, evaluable way 
sympa/rc/dump () {
    local k v
    for k v ( ${(kv)SYMPARC} ) print "$k $v"
}

# ask archived to remove or rebuild a list given its address
# sympa/archived remove old-list
# sympa/archived remove old-list@exemple.com

sympa/archived () {
    locale cmd=$1 addr=$2
    [[ $cmd == re(build|move) ]] || {
	warn "$cmd isn't a valid command"
	return
    }
    [[ $addr == *@* ]] || addr=$addr@$SYMPARC[bot]
    touch $SYMPARC[queueoutgoing]/.$cmd.$addr
}

sympa/bot/ls () {
    (cd $SYMPARC[root] &&
	print -l $~SYMPARC[botglob](e:'
	    test -d $REPLY -a ! -e $REPLY/config
	':))
}

# better ? 
# SYMPA_MATCHES_BOTS="/etc/sympa/*.(eu|fr)(/:t)"
# ls_bots () { print -l $~SYMPA_MATCHES_BOTS }

sympa/list/path () {
    IFS=@ read list bot <<< ${1:?name of the list}
    print $SYMPARC[root]/$bot/$list
}

sympa/bot/cd      () { cd $SYMPARC[bot]/$1 }
sympa/list/cd     () { cd $(sympa/list/path $1) }
sympa/list/config () { print $(sympa/list/path $1)/config } 

sympa/list/mv () {
    local new robot
    IFS=@ read new robot <<< ${2:?usage: mv old new}  
    : ${robot:=$SYMPARC[bot]}

    local old=$1
    [[ $old == *@* ]] || old=$old@$SYMPARC[bot]

    $SYMPARC[pl] \
	--rename_list=$old      \
	--new_listname=$new     \
	--new_listrobot=$robot
}

sympa/list/close () {
    local list=${1:?addr of the list to close} 
    [[ $list == *@* ]] || old=$list@$SYMPARC[bot]
    $SYMPARC[pl] --close_list=$list
}

sympa/subscribers/dump/cat () {
    sympa/subscribers/dump/prepare $1
    local p=$( sympa/subscribers/dump/path $1 ) && cat $p
}

sympa/subscribers/dump/path () {
	: ${1:?the name of the list is expected as argument}
	local user domain
	IFS=@ read user domain <<< "$1"
	echo ~/expl/${domain:-$SYMPARC[bot]}/$user/subscribers.db.dump
} 

sympa/subscribers/dump/prepare/now () {
    # typical usage is: cat $( sympa/subscribers/dump/prepare/now staff )
    local list=${1:?the name of the list is expected as argument}
    [[ $list == *@* ]] || list=$list@$SYMPARC[bot]
    sympa --dump=$list
    sympa/subscribers/dump/path $list
}

sympa/subscribers/dump/prepare/when () {
    # typical usage is: cat $( sympa/subscribers/dump/prepare staff@example.com )
    local list=${1:?the name of the list is expected as argument} 
    shift
    local p=$( sympa/subscribers/dump/path $list )
    find $p "$@" && sympa --dump=$list
    $p
}

sympa/subscribers/dump/filter/count  () { grep -c '^e' "$@" }
sympa/subscribers/dump/filter/emails () { sed -n 's/^email //p' "$@" }
